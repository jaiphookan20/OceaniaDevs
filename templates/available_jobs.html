<!DOCTYPE html>
<html>
  <head>
    <title>Available Jobs</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/available_jobs.css') }}"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function () {
        /* Function to handle Apply button click */
        $(document).on("click", ".apply-btn", function () {
          var jobid = $(this).data("jobid");
          console.log("Applied jobid: " + jobid);
          $.ajax({
            url: "/apply_to_job",
            type: "POST",
            data: JSON.stringify({ jobid: jobid }),
            contentType: "application/json",
            success: function (response) {
              console.log(`success response: ${response}`);
              alert(response.message);
            },
            error: function (xhr, status, error) {
              console.log(`error status: ${status}`);
              console.log(`error: ${error}`);
              alert(error);
            },
          });
        });

        /* Function to handle Bookmark button click */
        $(document).on("click", ".bookmark-btn", function () {
          var jobid = $(this).data("jobid");
          console.log("Bookmarked jobid: " + jobid);
          $.ajax({
            url: "/bookmark_job",
            type: "POST",
            data: JSON.stringify({ jobid: jobid }),
            contentType: "application/json",
            success: function (response) {
              alert(response.message);
            },
            error: function (xhr, status, error) {
              console.log("Error:", error);
              alert(error);
            },
          });
        });

        /* Function to handle View button click */
        $(document).on("click", ".view-btn", function () {
          var jobid = $(this).data("jobid");
          window.location.href = `/job_post/${jobid}`;
        });

        /* Function to handle Search input key press */
        $("#search-input").on("input", function () {
          var query = $(this).val();
          $.ajax({
            url: "/search_jobs",
            type: "GET",
            data: { query: query },
            success: function (response) {
              var jobs = response.results;
              var tbody = $("tbody");
              tbody.empty();
              $.each(jobs, function (index, job) {
                var row = `<tr>
                                <td>${job.title}</td>
                                <td>${job.company_name}</td>
                                <td>${job.city}, ${job.state}, ${job.country}</td>
                                <td class="actions">
                                    <button class="apply-btn" data-jobid="${job.job_id}">Apply</button>
                                    <button class="bookmark-btn" data-jobid="${job.job_id}">Bookmark</button>
                                    <button class="view-btn" data-jobid="${job.job_id}">View</button>
                                </td>
                            </tr>`;
                tbody.append(row);
              });
            },
            error: function (xhr, status, error) {
              console.log("Error:", error);
            },
          });
        });
      });
      $(document).ready(function () {
        // Debounce function to limit the rate of API calls
        function debounce(func, delay) {
          let debounceTimer;
          return function () {
            const context = this;
            const args = arguments;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(context, args), delay);
          };
        }

        // Function to handle search and populate the job list
        function handleSearch() {
          var query = $("#search-input").val();
          $.ajax({
            url: "/search_jobs",
            type: "GET",
            data: { query: query },
            success: function (response) {
              var jobs = response.results;
              var tbody = $("tbody");
              tbody.empty();
              $.each(jobs, function (index, job) {
                var row = `<tr>
                            <td>${job.title}</td>
                            <td>${job.company_name}</td>
                            <td>${job.city}, ${job.state}, ${job.country}</td>
                            <td class="actions">
                                <button class="apply-btn" data-jobid="${job.job_id}">Apply</button>
                                <button class="bookmark-btn" data-jobid="${job.job_id}">Bookmark</button>
                                <button class="view-btn" data-jobid="${job.job_id}">View</button>
                            </td>
                        </tr>`;
                tbody.append(row);
              });
            },
            error: function (xhr, status, error) {
              console.log("Error:", error);
            },
          });
        }

        // Debounced version of the handleSearch function
        var debouncedSearch = debounce(handleSearch, 300);

        // Event listener for the search input
        $("#search-input").on("input", debouncedSearch);
      });
    </script>
  </head>
  <body>
    <h1>Available Jobs</h1>
    <div>
      <input type="text" id="search-input" placeholder="Search for jobs..." />
    </div>
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Company</th>
          <th>Location</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for job in jobs %}
        <tr>
          <td>{{ job[1] }}</td>
          <td>{{ job[2] }}</td>
          <td>{{ job[3] }}, {{ job[4] }}, {{ job[5] }}</td>
          <td class="actions">
            <button class="apply-btn" data-jobid="{{ job[0] }}">Apply</button>
            <button class="bookmark-btn" data-jobid="{{ job[0] }}">
              Bookmark
            </button>
            <button class="view-btn" data-jobid="{{ job[0].job_id }}">
              View
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </body>
</html>
