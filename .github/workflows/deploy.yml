name: CI/CD Pipeline

on:
  push:
    branches:
      - llama-integration

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # - name: Set up Node.js
      #   uses: actions/setup-node@v2
      #   with:
      #     node-version: '14'

      # - name: Install dependencies
      #   run: |
      #     cd frontend
      #     npm install

      # - name: Build the React app
      #   env:
      #     CI: false
      #   run: |
      #     cd frontend
      #     npm run build

      # - name: Archive production artifacts
      #   uses: actions/upload-artifact@v2
      #   with:
      #     name: build
      #     path: ./frontend/build

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      # - name: Download build artifact
      #   uses: actions/download-artifact@v2
      #   with:
      #     name: build
      #     path: ./frontend/build

      - uses: easingthemes/ssh-deploy@v5.0.0
        name: Deploy over SSH
        with:
          SSH_PRIVATE_KEY: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          SCRIPT_BEFORE: |
              cd -
              ls
          SOURCE: "../frontend/build"
          REMOTE_HOST: ${{ secrets.LIGHTSAIL_HOST }}
          REMOTE_USER: ${{ secrets.LIGHTSAIL_USER }}
          TARGET: "OceaniaDevs/frontend/build"
          SCRIPT_AFTER: |
              echo "Connected Succesfully and Transferred requirements file"
              ls

      # - name: Test SSH connection
      #   uses: appleboy/ssh-action@v0.1.4
      #   with:
      #     host: ${{ secrets.LIGHTSAIL_HOST }}
      #     username: ${{ secrets.LIGHTSAIL_USER }}
      #     key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
      #     script: echo "SSH connection successful"

      # - name: Copy files via SCP
      #   uses: appleboy/scp-action@v0.1.1
      #   with:
      #     host: ${{ secrets.LIGHTSAIL_HOST }}
      #     username: ${{ secrets.LIGHTSAIL_USER }}
      #     key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
      #     source: "frontend/build"
      #     target: "./OceaniaDevs/frontend/build"
      #     debug: true

      # - name: SSH and restart Docker containers
      #   uses: appleboy/ssh-action@v0.1.4
      #   with:
      #     host: ${{ secrets.LIGHTSAIL_HOST }}
      #     username: ${{ secrets.LIGHTSAIL_USER }}
      #     key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
      #     script: |
      #       cd ~/OceaniaDevs
      #       docker-compose -f docker-compose.yml -f docker-compose.prod.yml down
      #       docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build